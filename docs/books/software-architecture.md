# ソフトウェアアーキテクチャの基礎

## 3. モジュール性

### 定義

モジュールとは、関連するコードを論理的にグループ化したもの。モジュール性とは、グループ化がどれだけうまく行われているかを示す指標。

ほとんどの言語にはモジュールを定義するための仕組み、例えばクラスや関数や名前空間などが備わっている。開発者はそれらを活用しながらモジュール性を実現していく。

ソフトウェアは常にエントロピー増大の危機にさらされており、良い状態を保つには常にエネルギーを費やし続けて秩序（≒ モジュール性）を維持する必要がある。

モジュール性の話はアーキテクチャ特性には一般的には含まれず暗黙的ではあるものの、重要な要素である。

### モジュール性の指標とその計測手法

#### 凝集度 / Cohesion

モジュール内の要素がどれだけ密接に関連しているかを示す指標で、高いほど良い。凝集度が低いということは、別のモジュールと結合しないかぎり有益な結果がえられないということだから。

LCOM という、フィールドを介して結合されていないメソッド群の数により、クラスの凝集度の低さを計測する方法がある。

#### 結合度

モジュール間の依存関係の強さを表す指標。

求心性結合(Afferent Coupling)は外部からの接続数であり、これが多いということは、他の複数のモジュールからよく利用されている状態を指す。システムにとって重要なサービスを提供している可能性がある。

遠心性結合(Efferent Coupling)は外部に向いた接続数であり、これが多いということは、他の複数のモジュールを利用している状態を指す。他のモジュールに多く依存しているため、変更の影響を受けやすい可能性があり、この状態を**不安定度**が高いと言う。

#### 抽象度

モジュール内における、抽象(抽象クラスやインターフェース等)と実装の比率のこと。抽象度が高いということは、モジュールが抽象的で、実装の詳細が隠蔽されているということ。

main メソッドしかない巨大な関数なら抽象度は 0 で、逆にインターフェースだけのクラスなら抽象度は 1 になる。

## 9. アーキテクチャスタイル

アーキテクチャパターンともいう。

### 基礎的なパターン

例えば「レイヤー」の概念は古くから存在する。

巨大な泥団子 / Big Ball of Mud はアーキテクチャ構造が存在しないクソコードのこと。残念ながら現実世界で非常によく見られる。

1 層アーキテクチャ(ユニタリーアーキテクチャ)は、ただ 1 つのコンピューターとその上で動くソフトウェアのこと。コンピューター黎明期のメインフレームなどが該当する。現代にはあまり存在しない。

2 層アーキテクチャ(クライアント・サーバー)は、Access のようなデスクトップアプリ + DB サーバーの構成や、現在の Web アプリのようなブラウザ + Web サーバーの構成を指す。

3 層アーキテクチャもある。JS フロントエンド + アプリケーションサーバー + 強力な商用 DB サーバー (Java とか)など。90 年代後半に流行った。

### モノリシック vs 分散

- モノリシック
  - レイヤードアーキテクチャ
  - パイプラインアーキテクチャ
  - マイクロカーネルアーキテクチャ
- 分散
  - サービスベースアーキテクチャ
  - イベント駆動アーキテクチャ
  - スペースベースアーキテクチャ
  - サービス指向アーキテクチャ
  - マイクロサービスアーキテクチャ

分散アーキテクチャは強力だが、以下のような問題に対処する必要があり、大きなトレードオフである。

---

**ネットワークは信頼できない**ので、タイムアウトやサーキットブレーカーのような機構が必要になる。

関数呼び出しの**レイテンシーが大きい**。ローカル呼び出しならナノ秒で住むが、RPC などはミリ秒単位になる。ロングテールレイテンシー(95-99%タイルのレイテンシー)を知っておくことが大事。

**帯域幅は有限**であるため、GraphQL のような必要最低限のデータを取得する仕組みがないと、あっという間に食いつぶす。

**ネットワークは安全ではない**。攻撃を受ける表面積が飛躍的に増えるので、高度なセキュリティ対策が必要になる。

**常に変化するネットワークトポロジー**（接続形態）への対応が必要。ちょっとした機器の更新がレイテンシーに影響を与えてタイムアウトを引き起こすようになることも。

ネットワーク**管理者はたくさんいる**。コミュニケーションを取るべき管理者は一人では済まず、コストがかかる。

**転送コストがかかる**。これはレイテンシーの話ではなく RESTful 呼び出しにかかる費用の話で、モノリスと比べるとかなり高い。

**ネットワークにはムラがある**。ネットワーク内には違うメーカーの機器が存在するし、それらが協調してうまく動く保証はない。

**ロギングが難しい**。分散ロギングしないと問題の追跡ができない。

**トランザクションが難しい**。分散トランザクションにより結果整合性を担保する必要がある。ACID トランザクションのように即時の一貫性は保証できない。
