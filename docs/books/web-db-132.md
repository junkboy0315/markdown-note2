# Web + DB vol.132

## テストダブル

- テストダブルとは
  - 自動テストに使用する偽物・代用品のこと
    - ダブル = 影武者、身代わりの意
    - Stub, Spy, Mock, Fake などの種類がある
  - 忠実性を下げる代わりに、テストの速度や決定性を向上させる技術
    - 忠実性 / Fidelity / 本物を模した度合い
    - 決定性 / Determinism / ある出来事が、その出来事に先行する出来事のみによって決定する性質
      - 決定性が高いテストとは
        - テスト対象コードの実装によってのみテストの結果が左右される
        - 外部のランダムな要因によってテストの結果が変わらない
- メリット
  - テストしにくいものをテスト可能にする
  - テストの速度と決定性を向上させる
- デメリット
  - テストが脆くなり、変更を妨げる
    - もしそもそもの設計がダメなのなら、テストダブルでごまかすな
  - テストの偽陰性をまねく
    - 偽陰性 / 失敗してほしいテストが失敗してくれないこと
      - テストダブルが本物と同じ動きをする保証はない
      - モックドリフト / テストダブルの実装が本物とズレてしまった状態
- オススメの手法
  - テストダブルは、決定性の向上のために使う。単なる速度向上のためには使わない。

## 現場でコードを書き続ける

- 勉強だけしてると痛い人になりがち
  - 覚えたテクニックを全部使いたがったり、とにかく流行りの技術を使いたがって、結果的に現場を混乱させるとか
- 現場の課題を解決する経験を積むべし
  - ピアノはピアノを弾くことでしかうまくならないし、サッカーもサッカーをすることでしかうまくならない
  - オープンソースへの貢献もいい

## sync/atomic による変数操作

- Golang の排他制御は通常`sync.(RW)Mutex`により行う
  - コードの一定の範囲をデータ競合から守る
- これとは別に`sync/atomic`という手法もある
  - 効率が良い一方で、とても分かりにくいバグを生む可能性もある両刃の剣
  - 変数が単体であり、値の操作が 1 つで済む場合に使うと良い、かも
