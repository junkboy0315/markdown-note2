# Software Design 202404

## リソースレコード変更時のベストプラクティス

リソースレコードの設定変更は即時に反映されない場合がある。このため、TTL をあらかじめ 300 秒くらいに短くしておくのがよい。ただし、後で戻すのを忘れずに。通常は 3,600 秒くらいがよい。

もしトラブルシュートが必要になったら、dig を使って非再帰問い合わせをしたり、キャッシュ問題の切り分けのために別のネットワークや端末から確認してみたりするのが有効である。

### ネガティブキャッシュ問題

サブドメインを新たに設定する際などに、設定前に（まだ存在しない）サブドメインにアクセスしたときに上位の権威サーバが`NODOMAIN`を返すことで、その情報が TTL 期間キャッシュされてしまい、その間はサブドメインにアクセスできなくなる問題。非常に厄介な問題だが、dig での非再帰問い合わせや、別のキャッシュサーバを使って状況を確認するのが有効。

### 権威サーバ引っ越し時のベストプラクティス

権威サーバ(ドメイン管理サイトで登録している NS レコードのこと)を引っ越す場合には、TTL が効かない。このため、数日間は新旧どちらの権威 DNS にもリクエストが飛ぶことになる。スムーズな移行のためには以下の手順を踏むことが大事。

- 新旧権威サーバでリソースレコードをあらかじめ同期しておく
- 権威サーバ(e.g. Napecheap のコンソールで登録している NS レコードの内容)を書き換えて数日待つ
- その後、もし A レコードの変更などがあわせて必要であれば前述の手順に沿って行う

## Chrome

画面を描写する仕組みは、Content、レンダリングエンジン(Blink 本体)、サードパーティライブラリ(V8, Skia ほか)の３層からなる。

Content が提供する Content public API によって Chrome その他の各種ブラウザから利用できるようになっている。

プロセスには以下のようなものがある。

- ブラウザプロセス
  - Web サイトの描写エリアの外側に責務を負う
  - 戻るボタンやブックマークの機能など
  - プロセスは 1 つ
- レンダープロセス
  - Web サイトの描写を行う
  - タブごとに 1 つずつのプロセス
- Viz プロセス
  - 前述の２つのプロセスを組み合わせて実際に画面を描写する
  - プロセスは 1 つ

## 開発者体験

腐った iOS アプリを再建した手順を紹介。

まずは UI テストの実装。Firebase Test Lab 上で UI テストを実装した。画面操作を行った後に、正しいリクエストが送信されるか検証するもの。

次にリアーキテクチャ。TCA という Redux 的なものを導入して状態変化を追いやすくした。

他にも Renovate によるライブラリの自動更新や、VRT の導入などを行った。

## データベースリファクタリング

「キャッシュ中毒」というアンチパターンがある。サービスが強くキャッシュに依存してしまい、非常に壊れやすくなり、運用が難しくなる状態のこと。一方で過度な忌避もよくない。適切なバランスを保つことが重要。

まずは RDBMS の性能を使い切るのが先。ほとんどの問題はこれで解消される。具体的には、インデックスの活用、クエリの最適化、テーブルの正規化など。

キャッシュに適しているものは以下のとおり。

- アクセス数が多い
- 計算コストが高い
- 更新頻度が少ない

また、データ更新のアルゴリズム、生存期間のアルゴリズムには様々な種類があるので、最適なものを選択すること。

## AWS Systems Manager

AWS Systems Manager は、サーバの管理を行うためのサービス。Lanscope Cat + α みたいなやつで、情報収集、リモート操作、パッチの適用、メンテナンス処理などを行うことができる。他クラウドやオンプレのサーバ、IoT デバイスにも対応している。
