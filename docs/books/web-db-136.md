# Web + DB vol.136

## 脆いテスト

- 自動テストを書く動機
  - 不具合混入を防止する
  - 問題箇所の絞り込みを容易にする
  - 動く仕様書になる
  - ソフトウェアの成長を持続可能なものにする（コレが一番大事）
    - 変更しやすく、変更に対応できるソフトウェアが競争力になる時代だから
- 保守性
  - モジュール性
  - 再利用性
  - 解析性（理解容易性）
  - 修正性（変更容易性）
  - 試験性（テスト容易性）
- 自動テストは最後の 2 つを向上させる
- 保守性とは、現状維持力ではなく、反応速度、改善力、推進力と考えろ
- よくある意見
  - 設計が変わりやすいのでテストを書くコストが高い
  - テストの修正コストが大きい
  - 設計が固まらないからテストが書けない
- 脆いテスト
  - 偽陽性のひとつ
  - コードが正しいにもかかわらずテストが失敗する誤検知のこと
  - ちな、コードに一切手を加えていないのにテストが失敗するのは「信頼不能テスト(Flaky Test)」という
- 脆いテストの原因
  - テストコードとテスト対象の高すぎる構造的結合度
- 指針
  - 公開 API 経由でテストする
    - 実装の詳細はテストしない
  - 構造単位ではなく振る舞い単位でテストする
    - クラスやメソッド、関数単位でテストを書かない
    - 振る舞いや責務に対してテストを書く
      - 1 つの関数が 3 つの仕事を請け負うなら 3 つのテストを書く
  - 相互作用ではなく事後状態をテストする
    - テスト対象の依存対象までモックしてテストなどをやり出すのは諸刃の剣
    - あくまで外部から見た振る舞いをテストする
      - e.g. テスト対象のメソッドの戻り値
      - e.g. テスト対象のメソッド実行後の状態
